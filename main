#!/bin/bash

#PBS -l nodes=1:ppn=4,vmem=100gb,walltime=00:59:00
#PBS -N pRF
#PBS -V

module unload matlab
module load matlab/2017a

module unload singularity && module load singularity/2.6.1

fsdir=$(jq -r .output config.json)

export LD_LIBRARY_PATH=/N/u/davhunt/Carbonate/workbench/libs_rh_linux64:/N/u/davhunt/Carbonate/workbench/libs_rh_linux64_software_opengl:/N/soft/rhel7/matlab/MATLAB_Compiler_Runtime/v92/runtime/glnxa64:/N/soft/rhel7/matlab/MATLAB_Compiler_Runtime/v92/bin/glnxa64:/N/soft/rhel7/matlab/MATLAB_Compiler_Runtime/v92/sys/os/glnxa64:$LD_LIBRARY_PATH

mkdir -p prf/prf_surfaces prf/surfaces

[ -z "$FREESURFER_LICENSE" ] && echo "Please set FREESURFER_LICENSE in .bashrc" && exit 1;
echo $FREESURFER_LICENSE > license.txt

time singularity exec -e -w docker://davhunt/wb_freesurfer:3.0 ./compiled/main

time singularity exec -e -w docker://brainlife/dipy:0.16.0 ./create_curv.py

rm -f prf_results.mat

time singularity exec -e -B `pwd`/license.txt:/usr/local/freesurfer/license.txt docker://brainlife/freesurfer:6.0.1 ./create_vtks.sh $fsdir
